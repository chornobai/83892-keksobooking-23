(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{F:()=>B});const t=e=>"Escape"===e.key||"Esc"===e.key;document.querySelector(".map__canvas");const r=document.querySelector("#card").content.querySelector(".popup"),o={palace:"Дворец",flat:"Квартирка",house:"Домик",bungalow:"Бунгало",hotel:"Отель"},n=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.querySelector(".error__message").textContent="Ошибка загрузки данных",document.body.appendChild(e);const t=r=>{r.preventDefault(),e.remove(),document.removeEventListener("click",t)};document.addEventListener("click",t)},a=["gif","jpg","jpeg","png"],c=document.querySelector(".ad-form__field input[type=file]"),i=document.querySelector(".ad-form-header__preview").querySelector("img"),l=document.querySelector(".ad-form__upload input[type=file]"),s=document.querySelector(".ad-form__photo");var d,u,p,m;l.addEventListener("change",(u=s,void(d=l).addEventListener("change",(()=>{const e=d.files[0],t=e.name.toLowerCase();if(a.some((e=>t.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{const e=document.createElement("img");e.src=t.result,e.alt="Фотография жилья",e.style.width="100%",u.appendChild(e),e.parentElement.style.display="flex"})),t.readAsDataURL(e)}})))),c.addEventListener("change",(m=i,void(p=c).addEventListener("change",(()=>{const e=p.files[0],t=e.name.toLowerCase();if(a.some((e=>t.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{m.src=t.result})),t.readAsDataURL(e)}}))));const f=document.querySelector(".ad-form"),v=f.querySelector(".ad-form__reset"),y=document.querySelectorAll("form"),h=document.querySelector("#address"),g=document.querySelectorAll("fieldset"),S=document.querySelector("#title"),_=document.querySelector("#price"),q=document.querySelector("#type"),E=document.querySelector("#room_number"),b=document.querySelector("#timein"),k=document.querySelector("#timeout"),w=document.querySelector("#capacity").querySelectorAll("option"),C={1:[1],2:[1,2],3:[1,2,3],100:[0]},x={bungalow:0,flat:1e3,hotel:3e3,house:5e3,palace:1e4};S.addEventListener("input",(()=>{const e=S.value.length;S.validity.valueMissing?S.setCustomValidity("Заполните обязательное поле"):e<30?S.setCustomValidity(`Eщё ${30-e} симв.`):e>100?S.setCustomValidity(`Удалите лишние ${e-100} симв.`):S.setCustomValidity(""),S.reportValidity()})),_.addEventListener("input",(()=>{const e=_.value.length;_.validity.valueMissing?_.setCustomValidity("Заполните обязательное поле"):e<0?_.setCustomValidity(`Eщё ${0-e} симв.`):e>7?_.setCustomValidity(`Удалите ${e-7} симв.`):_.setCustomValidity(""),_.reportValidity()}));const $=()=>{var e;e=Number(E.value),w.forEach((e=>{e.disabled=!0})),C[e].forEach((e=>{w.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};$(),E.addEventListener("change",(()=>{$()})),b.addEventListener("change",(e=>{k.value=e.target.value})),k.addEventListener("change",(e=>{b.value=e.target.value})),q.addEventListener("change",(e=>{_.placeholder=x[e.target.value],_.min=x[e.target.value]})),f.addEventListener("submit",(e=>{var r,o,n;e.preventDefault(),r=()=>((()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.body.appendChild(e);const r=t=>{t.preventDefault(),e.remove(),document.removeEventListener("click",r)},o=r=>{r.preventDefault(),t&&(e.remove(),document.removeEventListener("keydown",o))};document.addEventListener("click",r),document.addEventListener("keydown",o)})(),f.reset(),j()),o=()=>((()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=e.querySelector(".error__button");document.body.appendChild(e);const o=t=>{t.preventDefault(),e.remove(),document.removeEventListener("click",o)},n=r=>{r.preventDefault(),t&&(e.remove(),document.removeEventListener("keydown",n))},a=t=>{t.preventDefault(),e.remove(),r.removeEventListener("click",a)};document.addEventListener("click",o),document.addEventListener("keydown",n),r.addEventListener("click",a)})(),j()),n=new FormData(e.target),fetch("https://23.javascript.pages.academy/keksobooking",{method:"POST",body:n}).then((e=>{e.ok?r():o()})).catch((()=>{o()}))}));const D=35.69493,V=139.75459,A=[],T=L.map("map-canvas"),F=L.icon({iconUrl:"/img/main-pin.svg",iconSize:[50,50],iconAnchor:[25,50]}),N=L.marker({lat:D,lng:V},{draggable:!0,icon:F}),j=()=>{h.value="35.69493, 139.75459"};N.addTo(T),j(),N.on("moveend",(e=>{h.value=`${e.target.getLatLng().lat.toFixed(5)}, ${e.target.getLatLng().lng.toFixed(5)}`}));const M=L.layerGroup().addTo(T),O=e=>{e.slice(0,10).forEach((e=>{const t=L.icon({iconUrl:"img/pin.svg",iconSize:[40,40],iconAnchor:[20,40]}),n=L.marker({lat:e.location.lat,lng:e.location.lng},{icon:t});n.addTo(M).bindPopup((e=>{const t=r.cloneNode(!0);t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=`${e.offer.price} ₽/ночь`,t.querySelector(".popup__type").textContent=o[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin} выезд до ${e.offer.checkout}`;const n=t.querySelector(".popup__features"),a=e.offer.features;var c,i;a?(c=a,(i=n).innerHTML="",c.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature",`popup__feature--${e}`),i.appendChild(t)}))):n.remove(),e.offer.description?t.querySelector(".popup__description").textContent=e.offer.description:t.querySelector(".popup__description").remove();const l=t.querySelector(".popup__photos"),s=e.offer.photos;return s?function(e,t){t.innerHTML="",e.forEach((e=>{const r=document.createElement("img");r.classList.add("popup__photo"),r.src=e,r.alt="Фотография жилья",r.width=45,r.height=40,t.appendChild(r)}))}(s,l):l.remove(),t})(e),{keepInView:!0}),A.push(n)}))},P="any",R=document.querySelector(".map__filters"),U=R.querySelectorAll(".map__checkbox"),z=R.querySelector("#housing-type"),H=R.querySelector("#housing-price"),I=R.querySelector("#housing-rooms"),W=R.querySelector("#housing-guests"),G=e=>function(e,t=500){let r;return(...o)=>{clearTimeout(r),r=setTimeout((()=>e.apply(this,o)),t)}}((t=>{t.preventDefault();const r=(e=>e.filter((e=>(e=>z.value===P||e.offer.type===z.value)(e)&&(e=>{switch(H.value){case"any":return!0;case"low":return e.offer.price<1e4;case"middle":return 1e4<e.offer.price&&e.offer.price<5e4;case"high":return e.offer.price>5e4;default:return!1}})(e)&&(e=>I.value===P||Number(I.value)===e.offer.rooms)(e)&&(e=>W.value===P||Number(W.value)===e.offer.guests)(e)&&(e=>Array.from(U).every((t=>!t.checked||!!e.offer.features&&e.offer.features.includes(t.value))))(e))))(e);A.forEach((e=>{e.remove()})),O(r)}),500);y.forEach((e=>{e.classList.add("ad-form--disabled")})),g.forEach((e=>{e.setAttribute("disabled","disabled")})),T.on("load",(()=>{y.forEach((e=>{e.classList.remove("ad-form--disabled")})),g.forEach((e=>{e.removeAttribute("disabled")}))})).setView({lat:D,lng:V},13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>'}).addTo(T);const B=()=>{var e,t;e=e=>{O(e),(e=>{R.addEventListener("change",G(e))})(e)},t=n,fetch("https://23.javascript.pages.academy/keksobooking/data").then((e=>e.json())).then((t=>{e(t)})).catch((e=>{t(`Ошибка загрузки данных: "${e}"`)}))};B(),v.addEventListener("click",(e=>{e.preventDefault(),f.reset(),R.reset(),N.setLatLng({lat:D,lng:V}),j(),i.src="img/muffin-grey.svg",s.innerHTML="",B()}))})();